---
import { Autumn } from "autumn-js"

const PLAN_FEATURES: Record<string, { label: string; value: string }[]> = {
    starter: [
        { label: "14-day retention", value: "" },
        { label: "Unlimited dashboards", value: "" },
        { label: "Advanced alerting", value: "" },
        { label: "Full API", value: "" },
        { label: "Email support", value: "" },
    ],
    startup: [
        { label: "30-day retention", value: "" },
        { label: "Unlimited dashboards", value: "" },
        { label: "Advanced alerting", value: "" },
        { label: "Full API", value: "" },
        { label: "Private Channel support", value: "" },
    ],
}

interface PlanCard {
    name: string
    slug: string
    price: number
    interval?: string
    isFree: boolean
    hasTrial: boolean
    subtitle: string
    dataFeatures: { label: string; value: string; detail?: string }[]
    platformFeatures: { label: string }[]
    ctaLabel: string
    ctaStyle: "outline" | "accent"
}

let plans: PlanCard[] = []

try {
    const autumn = new Autumn({ secretKey: import.meta.env.AUTUMN_SECRET_KEY })
    const result = await autumn.products.list()

    if (result.data) {
        const products = result.data.list
            .filter((p) => !p.is_add_on)
            .sort((a, b) => {
                if (a.properties.is_free && !b.properties.is_free) return -1
                if (!a.properties.is_free && b.properties.is_free) return 1
                const priceA = a.items.find((i) => !i.feature_id && i.price != null)?.price ?? 0
                const priceB = b.items.find((i) => !i.feature_id && i.price != null)?.price ?? 0
                return priceA - priceB
            })

        plans = products.map((product) => {
            const isFree = product.properties.is_free
            const slug = isFree ? "starter" : product.id?.toLowerCase() ?? product.name?.toLowerCase() ?? "startup"
            const baseItem = product.items.find((i) => !i.feature_id && i.price != null)
            const price = isFree ? 0 : (baseItem?.price ?? 0)
            const interval = baseItem?.interval

            const dataFeatures = product.items
                .filter((item) => item.feature_id)
                .map((item) => ({
                    label: item.feature?.name ?? item.feature_id ?? "",
                    value: item.included_usage === "inf" ? "Unlimited" : `${Number(item.included_usage ?? 0)} GB`,
                    detail: item.display?.secondary_text
                        ? item.display.secondary_text.replace(/\bper\s+[\d,]+\s+(Logs|Traces|Metrics)\b/i, "per GB")
                        : item.price != null
                          ? `then $${item.price} per GB`
                          : undefined,
                }))

            const platformFeatures = (PLAN_FEATURES[slug] ?? PLAN_FEATURES["startup"] ?? [])
                .map((f) => ({ label: f.label }))

            return {
                name: product.display?.name ?? product.name,
                slug,
                price,
                interval: interval ? `/${interval}` : undefined,
                isFree,
                hasTrial: product.properties.has_trial,
                subtitle: isFree ? "Free forever" : (product.display?.description ?? (slug === "starter" ? "For individuals and small projects" : "For growing teams")),
                dataFeatures,
                platformFeatures,
                ctaLabel: isFree ? "Get started free" : (product.free_trial ? `Start ${product.free_trial.length}-day free trial` : "Subscribe"),
                ctaStyle: isFree ? "outline" as const : "accent" as const,
            }
        })
    }
} catch (e) {
    console.error("Failed to fetch pricing from Autumn:", e)
}

// Fallback if fetch fails
if (plans.length === 0) {
    plans = [
        {
            name: "Starter",
            slug: "starter",
            price: 0,
            isFree: true,
            hasTrial: false,
            subtitle: "Free forever",
            dataFeatures: [
                { label: "Logs", value: "50 GB" },
                { label: "Traces", value: "50 GB" },
                { label: "Metrics", value: "50 GB" },
            ],
            platformFeatures: PLAN_FEATURES["starter"]!.map((f) => ({ label: f.label })),
            ctaLabel: "Get started free",
            ctaStyle: "outline",
        },
        {
            name: "Startup",
            slug: "startup",
            price: 29,
            interval: "/month",
            isFree: false,
            hasTrial: true,
            subtitle: "For growing teams",
            dataFeatures: [
                { label: "Logs", value: "100 GB", detail: "then $0.25/GB" },
                { label: "Traces", value: "100 GB", detail: "then $0.25/GB" },
                { label: "Metrics", value: "100 GB", detail: "then $0.25/GB" },
            ],
            platformFeatures: PLAN_FEATURES["startup"]!.map((f) => ({ label: f.label })),
            ctaLabel: "Start 30-day free trial",
            ctaStyle: "accent",
        },
    ]
}
---

<section class="py-16 md:py-24">
    <div class="mx-auto max-w-6xl px-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {plans.map((plan) => (
                <div class="border border-border bg-bg-elevated flex flex-col">
                    <div class="p-6 md:p-8 flex flex-col flex-1">
                        <div class="flex items-center gap-2">
                            <span class="text-[11px] uppercase tracking-widest text-fg-muted">{plan.name}</span>
                            {plan.hasTrial && (
                                <span class="inline-flex items-center rounded-full bg-accent/10 px-2 py-0.5 text-[10px] font-medium text-accent">
                                    30-day trial
                                </span>
                            )}
                        </div>
                        <div class="mt-2 text-4xl font-semibold text-fg">
                            ${plan.price}
                            {plan.interval && <span class="text-base font-normal text-fg-muted">{plan.interval}</span>}
                        </div>
                        <p class="mt-1 text-sm text-fg-muted">{plan.subtitle}</p>

                        <div class="mt-6">
                            <span class="text-[10px] uppercase tracking-widest text-fg-muted/70">Data included</span>
                            <div class="mt-3 space-y-3">
                                {plan.dataFeatures.map((feature) => (
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            {feature.label === "Logs" && (
                                                <svg class="w-4 h-4 text-fg-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                                            )}
                                            {feature.label === "Traces" && (
                                                <svg class="w-4 h-4 text-fg-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                            )}
                                            {feature.label === "Metrics" && (
                                                <svg class="w-4 h-4 text-fg-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 5 5-6"/></svg>
                                            )}
                                            <span class="text-sm text-fg">{feature.label}</span>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm text-fg-muted font-mono">{feature.value}</span>
                                            {feature.detail && (
                                                <p class="text-[10px] text-fg-muted/50 font-mono mt-0.5">{feature.detail}</p>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div class="my-6 h-px bg-border"></div>

                        <div>
                            <span class="text-[10px] uppercase tracking-widest text-fg-muted/70">Platform features</span>
                            <div class="mt-3 space-y-2.5">
                                {plan.platformFeatures.map((feature) => (
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-accent shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                                        <span class="text-sm text-fg-muted">{feature.label}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div class="mt-auto pt-8 space-y-2">
                            {plan.ctaStyle === "accent" ? (
                                <a href="/waitlist" class="block w-full bg-accent text-accent-foreground px-6 py-2.5 text-sm font-medium text-center hover:opacity-90 transition-opacity">
                                    {plan.ctaLabel}
                                </a>
                            ) : (
                                <a href="/waitlist" class="block w-full border border-border px-6 py-2.5 text-sm font-medium text-fg text-center hover:opacity-90 transition-opacity">
                                    {plan.ctaLabel}
                                </a>
                            )}
                            {plan.hasTrial && (
                                <p class="text-[11px] text-fg-muted text-center">
                                    You won't be charged for 30 days Â· Credit card required
                                </p>
                            )}
                        </div>
                    </div>
                </div>
            ))}
        </div>

        <!-- Enterprise -->
        <div class="mt-4 border border-border bg-accent/[0.02]">
            <div class="p-6 md:p-8">
                <div class="grid grid-cols-1 md:grid-cols-[1fr_1fr_1fr] gap-8">
                    <div>
                        <span class="text-[11px] uppercase tracking-widest text-fg-muted">Enterprise</span>
                        <div class="mt-2 text-4xl font-semibold text-fg">Custom</div>
                        <p class="mt-2 text-sm text-fg-muted leading-relaxed">Tailored pricing for high-volume teams with dedicated support and custom retention.</p>
                        <a href="/waitlist" class="mt-6 inline-block border border-border px-6 py-2.5 text-sm font-medium text-fg hover:opacity-90 transition-opacity">
                            Contact Sales
                        </a>
                    </div>

                    <div>
                        <span class="text-[10px] uppercase tracking-widest text-fg-muted/70">Data included</span>
                        <div class="mt-3 space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-fg-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                                    <span class="text-sm text-fg">Logs</span>
                                </div>
                                <span class="text-sm text-fg-muted font-mono">Custom</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-fg-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                    <span class="text-sm text-fg">Traces</span>
                                </div>
                                <span class="text-sm text-fg-muted font-mono">Custom</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-fg-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 5 5-6"/></svg>
                                    <span class="text-sm text-fg">Metrics</span>
                                </div>
                                <span class="text-sm text-fg-muted font-mono">Custom</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <span class="text-[10px] uppercase tracking-widest text-fg-muted/70">Platform features</span>
                        <div class="mt-3 space-y-2.5">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-accent shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                                <span class="text-sm text-fg-muted">Custom retention</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-accent shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                                <span class="text-sm text-fg-muted">Unlimited dashboards</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-accent shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                                <span class="text-sm text-fg-muted">Enterprise alerting</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-accent shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                                <span class="text-sm text-fg-muted">Full API</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-accent shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                                <span class="text-sm text-fg-muted">Priority support</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
