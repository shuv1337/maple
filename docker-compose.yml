services:
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    ports:
      - "3472:3472"
    env_file: .env
    environment:
      PORT: 3472
    depends_on:
      otel-collector:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3472/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:3472}
        VITE_MAPLE_AUTH_MODE: ${MAPLE_AUTH_MODE:-self_hosted}
    ports:
      - "3471:80"

  ingest:
    build:
      context: .
      dockerfile: apps/ingest/Dockerfile
    ports:
      - "3474:3474"
    env_file: .env
    environment:
      INGEST_PORT: 3474
      INGEST_FORWARD_OTLP_ENDPOINT: http://otel-collector:4318
      INGEST_FORWARD_TIMEOUT_MS: 10000
      INGEST_MAX_REQUEST_BODY_BYTES: 20971520
      INGEST_REQUIRE_TLS: "false"
    depends_on:
      otel-collector:
        condition: service_started

  otel-collector:
    build:
      context: .
      dockerfile: otel/Dockerfile
    ports:
      - "4317:4317"
      - "4318:4318"
      - "13133:13133"
    env_file: .env
